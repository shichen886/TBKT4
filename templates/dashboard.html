{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†è¿½è¸ªä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <style>
        /* å…¨å±€è®¾ç½®ä¾§è¾¹æ æ ·å¼ */
        .settings-sidebar {
            width: 240px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            overflow-y: auto;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .settings-sidebar.collapsed {
            width: 60px;
            padding: 1rem 0.5rem;
        }
        
        /* æ”¶èµ·æŒ‰é’® */
        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            background: rgba(102, 126, 234, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .sidebar-toggle:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
        }
        
        .settings-header {
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }
        
        .settings-header h3 {
            color: #667eea;
            margin: 0;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .settings-section {
            margin-bottom: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .settings-section h4 {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.6rem;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .settings-select {
            width: 100%;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .settings-select:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.2);
        }
        
        .settings-select option {
            background: #1a1a2e;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .settings-input {
            width: 100%;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .settings-input:hover {
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .settings-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* å¼€å…³æ ·å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 20px;
            margin-right: 0.6rem;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 20px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: rgba(102, 126, 234, 0.7);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(25px);
        }
        
        .toggle-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            vertical-align: middle;
        }
        
        .settings-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .settings-footer button {
            width: 100%;
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
            padding: 0.6rem;
        }
        
        /* æ”¶èµ·çŠ¶æ€ä¸‹çš„æ ·å¼ */
        .settings-sidebar.collapsed .settings-header h3,
        .settings-sidebar.collapsed .settings-section h4,
        .settings-sidebar.collapsed .toggle-label,
        .settings-sidebar.collapsed .settings-select,
        .settings-sidebar.collapsed .settings-input,
        .settings-sidebar.collapsed .settings-footer {
            display: none;
        }
        
        .settings-sidebar.collapsed .settings-section {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .settings-sidebar.collapsed .toggle-switch {
            margin-right: 0;
        }
        
        .settings-sidebar.collapsed .sidebar-toggle {
            right: 50%;
            transform: translateX(50%);
        }
        
        .settings-sidebar.collapsed .sidebar-toggle:hover {
            transform: translateX(50%) scale(1.1);
        }
        
        /* è°ƒæ•´å¸ƒå±€ */
        .dashboard-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .dashboard-container.sidebar-collapsed {
            grid-template-columns: 60px 1fr;
        }
        
        .dashboard-content {
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 220px 1fr;
            }
            
            .settings-sidebar {
                width: 220px;
                padding: 1.2rem;
            }
            
            .dashboard-container.sidebar-collapsed {
                grid-template-columns: 60px 1fr;
            }
            
            .dashboard-content {
                padding: 1.2rem;
            }
        }
        
        @media (max-width: 992px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            
            .dashboard-container.sidebar-collapsed {
                grid-template-columns: 1fr;
            }
            
            .settings-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                padding: 1.2rem;
            }
            
            .settings-sidebar.collapsed {
                width: 100%;
                padding: 1rem;
            }
            
            .settings-header {
                margin-bottom: 1rem;
            }
            
            .settings-section {
                margin-bottom: 1rem;
            }
            
            .settings-footer {
                margin-top: 1rem;
                padding-top: 1rem;
            }
            
            .sidebar-toggle {
                right: 1rem;
                top: 1rem;
                border-radius: 10px;
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="background-texture"></div>
    
    <div class="dashboard-container">
        <!-- å…¨å±€è®¾ç½®ä¾§è¾¹æ  -->
        <div class="settings-sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <span>Â«</span>
            </button>
            <div class="settings-header">
                <h3>âš™ï¸ å…¨å±€è®¾ç½®</h3>
            </div>
            <div class="settings-section">
                <h4>æ•°æ®é›†é€‰æ‹©</h4>
                <select id="datasetSelect" class="settings-select">
                    <option value="assistments2009">Assistments 2009</option>
                    <option value="assistments2015">Assistments 2015</option>
                    <option value="ednet">EdNet</option>
                    <option value="synthetic">åˆæˆæ•°æ®</option>
                </select>
            </div>
            <div class="settings-section">
                <h4>æ¨¡å‹é€‰æ‹©</h4>
                <select id="modelSelect" class="settings-select">
                    <option value="tensor_attention">å¼ é‡è‡ªæ³¨æ„åŠ›</option>
                    <option value="rnn">RNN</option>
                    <option value="lstm">LSTM</option>
                    <option value="gru">GRU</option>
                    <option value="apriori">Apriori</option>
                    <option value="avg">å¹³å‡ç®—æ³•</option>
                </select>
            </div>
            <div class="settings-section">
                <h4>çŸ¥è¯†è¿½è¸ªæ¨¡å‹</h4>
                <select id="ktModelSelect" class="settings-select">
                    <option value="dkt">DKT</option>
                    <option value="sakt">SAKT</option>
                    <option value="iekt">IEKT</option>
                    <option value="akt">AKT</option>
                    <option value="dkvmn">DKVMN</option>
                </select>
            </div>
            <div class="settings-section">
                <h4>è‡ªé€‚åº”å­¦ä¹ </h4>
                <label class="toggle-switch">
                    <input type="checkbox" id="adaptiveToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">å¯ç”¨è‡ªé€‚åº”</span>
            </div>
            <div class="settings-section">
                <h4>å­¦ä¹ ç›®æ ‡</h4>
                <input type="number" id="studyGoalInput" class="settings-input" placeholder="æ¯æ—¥å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)" min="1">
            </div>
            <div class="settings-footer">
                <button id="saveSettings" class="primary-button">ä¿å­˜è®¾ç½®</button>
                <button id="resetSettings" class="secondary-button">é‡ç½®é»˜è®¤</button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“Š</div>
                    <div class="stat-info">
                        <h3>çŸ¥è¯†ç‚¹ç»Ÿè®¡</h3>
                        <p class="stat-value">128</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-info">
                        <h3>å­¦ä¹ è¿›åº¦</h3>
                        <p class="stat-value">75%</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-info">
                        <h3>æ­£ç¡®ç‡</h3>
                        <p class="stat-value">82%</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">â±ï¸</div>
                    <div class="stat-info">
                        <h3>å­¦ä¹ æ—¶é•¿</h3>
                        <p class="stat-value" id="totalStudyTime">0h 0m</p>
                        <p class="today-study-time" id="todayStudyTime">ä»Šæ—¥: 0h 0m 0s</p>
                        <div class="timer-controls">
                            <button id="startTimer" class="primary-button">å¼€å§‹å­¦ä¹ </button>
                            <button id="stopTimer" class="primary-button" disabled>ç»“æŸå­¦ä¹ </button>
                            <button id="resetTimer" class="secondary-button">é‡ç½®æ•°æ®</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="charts-section">
                <div class="chart-card">
                    <h3>çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ</h3>
                    <div class="chart-container">
                        <canvas id="knowledgeChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3>å­¦ä¹ è¶‹åŠ¿</h3>
                    <div class="chart-container">
                        <canvas id="learningTrendChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- å­¦ä¹ å†å²è®°å½• -->
            <div class="history-section">
                <h3 class="section-title">å­¦ä¹ å†å²è®°å½•</h3>
                <div class="history-controls">
                    <button id="viewHistory" class="primary-button">æŸ¥çœ‹å†å²</button>
                    <button id="exportHistory" class="secondary-button">å¯¼å‡ºæ•°æ®</button>
                </div>
                <div id="historyTable" class="history-table">
                    <p class="history-placeholder">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹å†å²å­¦ä¹ è®°å½•</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¼“åŠ±å¼¹çª— -->
    <div id="encouragementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‰ å­¦ä¹ é¼“åŠ±</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="encouragementMessage">å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼</p>
            </div>
            <div class="modal-footer">
                <button class="primary-button close-modal">è°¢è°¢</button>
            </div>
        </div>
    </div>
    
    <script>
        // è®¡æ—¶å™¨åŠŸèƒ½
        let timerInterval;
        let startTime;
        let todayStudySeconds = 0;
        let totalStudySeconds = 0; // åˆå§‹å€¼0å°æ—¶ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½å®é™…æ•°æ®
        
        // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰
        function getTodayDate() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadStudyData() {
            const today = getTodayDate();
            const savedData = localStorage.getItem('studyData');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
                    if (data[today] !== undefined) {
                        todayStudySeconds = parseInt(data[today]) || 0;
                    }
                    if (data.total !== undefined) {
                        totalStudySeconds = parseInt(data.total) || 0;
                    }
                } catch (error) {
                    console.error('Failed to parse study data:', error);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œé‡ç½®æ•°æ®
                    todayStudySeconds = 0;
                    totalStudySeconds = 0;
                    localStorage.removeItem('studyData');
                }
            }
            
            updateDisplay();
        }
        
        // é‡ç½®æ‰€æœ‰å­¦ä¹ æ•°æ®
        function resetStudyData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ä¹ æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.removeItem('studyData');
                localStorage.removeItem('shownEncouragements');
                todayStudySeconds = 0;
                totalStudySeconds = 0;
                updateDisplay();
                alert('å­¦ä¹ æ•°æ®å·²é‡ç½®');
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveStudyData() {
            const today = getTodayDate();
            const savedData = localStorage.getItem('studyData');
            let data = savedData ? JSON.parse(savedData) : {};
            
            data[today] = todayStudySeconds;
            data.total = totalStudySeconds;
            
            localStorage.setItem('studyData', JSON.stringify(data));
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            // æ›´æ–°ä»Šæ—¥å­¦ä¹ æ—¶é•¿
            const todayHours = Math.floor(todayStudySeconds / 3600);
            const todayMinutes = Math.floor((todayStudySeconds % 3600) / 60);
            const todaySeconds = todayStudySeconds % 60;
            document.getElementById('todayStudyTime').textContent = `ä»Šæ—¥: ${todayHours}h ${todayMinutes}m ${todaySeconds}s`;
            
            // æ›´æ–°æ€»å­¦ä¹ æ—¶é•¿
            const totalHours = Math.floor(totalStudySeconds / 3600);
            const totalMinutes = Math.floor((totalStudySeconds % 3600) / 60);
            document.getElementById('totalStudyTime').textContent = `${totalHours}h ${totalMinutes}m`;
        }
        
        // æ˜¾ç¤ºé¼“åŠ±å¼¹çª—
        function showEncouragementPopup(minutes) {
            const messages = {
                30: "ğŸ‰ å¤ªæ£’äº†ï¼ä½ å·²ç»å­¦ä¹ äº†30åˆ†é’Ÿï¼Œç»§ç»­ä¿æŒï¼",
                60: "ğŸš€ ä¼˜ç§€ï¼ä½ å·²ç»ä¸“æ³¨å­¦ä¹ äº†1å°æ—¶ï¼Œå­¦ä¹ æ•ˆç‡çœŸé«˜ï¼",
                120: "ğŸŒŸ å¤ªå‰å®³äº†ï¼2å°æ—¶çš„æŒç»­å­¦ä¹ ï¼Œä½ æ˜¯çœŸæ­£çš„å­¦ä¹ è¾¾äººï¼",
                180: "ğŸ† è¶…çº§å­¦éœ¸ï¼3å°æ—¶çš„å­¦ä¹ æ—¶é—´ï¼Œä½ çš„åŠªåŠ›ä¸€å®šä¼šæœ‰å›æŠ¥ï¼",
                240: "ğŸ’ å­¦ä¹ å¤§å¸ˆï¼4å°æ—¶çš„ä¸“æ³¨ï¼Œä½ æ­£åœ¨åˆ›é€ å¥‡è¿¹ï¼",
                300: "ğŸ”¥ ä¼ å¥‡å­¦ä¹ è€…ï¼5å°æ—¶çš„å­¦ä¹ ï¼Œä½ å·²ç»è¶…è¶Šäº†å¤§å¤šæ•°äººï¼"
            };
            
            if (messages[minutes]) {
                document.getElementById('encouragementMessage').textContent = messages[minutes];
                document.getElementById('encouragementModal').style.display = 'flex';
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºé¼“åŠ±å¼¹çª—
        function checkEncouragement() {
            const minutes = Math.floor(todayStudySeconds / 60);
            
            // æ£€æŸ¥å…³é”®æ—¶é—´ç‚¹
            if (minutes === 30 || minutes === 60 || minutes === 120 || minutes === 180 || minutes === 240 || minutes === 300) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡è¯¥æ—¶é—´ç‚¹çš„å¼¹çª—
                const today = getTodayDate();
                const shownEncouragements = JSON.parse(localStorage.getItem('shownEncouragements') || '{}');
                
                if (!shownEncouragements[today] || !shownEncouragements[today][minutes]) {
                    showEncouragementPopup(minutes);
                    
                    // æ ‡è®°è¯¥æ—¶é—´ç‚¹çš„å¼¹çª—å·²æ˜¾ç¤º
                    if (!shownEncouragements[today]) {
                        shownEncouragements[today] = {};
                    }
                    shownEncouragements[today][minutes] = true;
                    localStorage.setItem('shownEncouragements', JSON.stringify(shownEncouragements));
                }
            }
        }
        
        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            startTime = Date.now();
            document.getElementById('startTimer').disabled = true;
            document.getElementById('stopTimer').disabled = false;
            
            timerInterval = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                todayStudySeconds += elapsedSeconds;
                totalStudySeconds += elapsedSeconds;
                startTime = Date.now();
                
                updateDisplay();
                saveStudyData();
                checkEncouragement();
            }, 1000);
        }
        
        // åœæ­¢è®¡æ—¶å™¨
        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('startTimer').disabled = false;
            document.getElementById('stopTimer').disabled = true;
            
            saveStudyData();
        }
        
        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('encouragementModal').style.display = 'none';
        }
        
        // æŸ¥çœ‹å†å²è®°å½•
        function viewHistory() {
            const savedData = localStorage.getItem('studyData');
            const historyTable = document.getElementById('historyTable');
            
            if (!savedData) {
                historyTable.innerHTML = '<p class="history-placeholder">æš‚æ— å­¦ä¹ å†å²è®°å½•</p>';
                return;
            }
            
            try {
                const data = JSON.parse(savedData);
                const totalSeconds = data.total || 0;
                
                // æå–æ¯æ—¥è®°å½•ï¼ˆæ’é™¤totalå­—æ®µï¼‰
                const dailyRecords = [];
                for (const [date, seconds] of Object.entries(data)) {
                    if (date !== 'total') {
                        dailyRecords.push({ date, seconds: parseInt(seconds) || 0 });
                    }
                }
                
                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                dailyRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // ç”Ÿæˆè¡¨æ ¼HTML
                let tableHTML = `
                    <div class="history-summary">
                        <div class="summary-item">
                            <span class="summary-label">æ€»å­¦ä¹ å¤©æ•°ï¼š</span>
                            <span class="summary-value">${dailyRecords.length}å¤©</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">æ€»å­¦ä¹ æ—¶é•¿ï¼š</span>
                            <span class="summary-value">${formatTime(totalSeconds)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">æ—¥å‡å­¦ä¹ æ—¶é•¿ï¼š</span>
                            <span class="summary-value">${dailyRecords.length > 0 ? formatTime(Math.round(totalSeconds / dailyRecords.length)) : '0h 0m'}</span>
                        </div>
                    </div>
                    <table class="history-data-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>å­¦ä¹ æ—¶é•¿</th>
                                <th>æ—¶é—´æ®µ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // æ·»åŠ æ¯æ—¥è®°å½•
                for (const record of dailyRecords) {
                    const hours = Math.floor(record.seconds / 3600);
                    const minutes = Math.floor((record.seconds % 3600) / 60);
                    const seconds = record.seconds % 60;
                    
                    // æ—¶é—´æ®µåˆ†ç±»
                    let timeCategory = 'çŸ­æœŸå­¦ä¹ ';
                    if (record.seconds >= 3600) timeCategory = 'æ·±åº¦å­¦ä¹ ';
                    else if (record.seconds >= 1800) timeCategory = 'ä¸­åº¦å­¦ä¹ ';
                    
                    tableHTML += `
                        <tr>
                            <td>${formatDate(record.date)}</td>
                            <td>${hours}h ${minutes}m ${seconds}s</td>
                            <td>${timeCategory}</td>
                        </tr>
                    `;
                }
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                historyTable.innerHTML = tableHTML;
            } catch (error) {
                console.error('Failed to view history:', error);
                historyTable.innerHTML = '<p class="history-placeholder">å†å²è®°å½•åŠ è½½å¤±è´¥</p>';
            }
        }
        
        // å¯¼å‡ºå†å²è®°å½•
        function exportHistory() {
            const savedData = localStorage.getItem('studyData');
            
            if (!savedData) {
                alert('æš‚æ— å­¦ä¹ å†å²è®°å½•å¯å¯¼å‡º');
                return;
            }
            
            try {
                const data = JSON.parse(savedData);
                
                // æå–æ¯æ—¥è®°å½•ï¼ˆæ’é™¤totalå­—æ®µï¼‰
                const dailyRecords = [];
                for (const [date, seconds] of Object.entries(data)) {
                    if (date !== 'total') {
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        const secondsLeft = seconds % 60;
                        
                        dailyRecords.push({
                            date: formatDate(date),
                            hours,
                            minutes,
                            seconds: secondsLeft,
                            total_seconds: seconds,
                            formatted_time: `${hours}h ${minutes}m ${secondsLeft}s`
                        });
                    }
                }
                
                // æŒ‰æ—¥æœŸæ’åº
                dailyRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // ç”ŸæˆCSVå†…å®¹
                const csvHeader = 'æ—¥æœŸ,å­¦ä¹ æ—¶é•¿(å°æ—¶),å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ),å­¦ä¹ æ—¶é•¿(ç§’),æ€»ç§’æ•°,æ ¼å¼åŒ–æ—¶é—´\n';
                const csvRows = dailyRecords.map(record => 
                    `${record.date},${record.hours},${record.minutes},${record.seconds},${record.total_seconds},"${record.formatted_time}"`
                ).join('\n');
                
                const csvContent = csvHeader + csvRows;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `å­¦ä¹ å†å²è®°å½•_${getTodayDate()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('å­¦ä¹ å†å²è®°å½•å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶');
            } catch (error) {
                console.error('Failed to export history:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆYYYY-MM-DD è½¬ä¸º YYYYå¹´MMæœˆDDæ—¥ï¼‰
        function formatDate(dateString) {
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return `${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;
            }
            return dateString;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’æ•°è½¬ä¸ºæ—¶åˆ†ç§’ï¼‰
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            loadStudyData();
            
            document.getElementById('startTimer').addEventListener('click', startTimer);
            document.getElementById('stopTimer').addEventListener('click', stopTimer);
            document.getElementById('resetTimer').addEventListener('click', resetStudyData);
            document.getElementById('viewHistory').addEventListener('click', viewHistory);
            document.getElementById('exportHistory').addEventListener('click', exportHistory);
            
            // å…³é—­å¼¹çª—äº‹ä»¶
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', closeModal);
            });
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('encouragementModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // åˆå§‹åŒ–å›¾è¡¨
            initKnowledgeChart();
            initLearningTrendChart();
        });
        
        // åˆå§‹åŒ–çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µå›¾è¡¨
        function initKnowledgeChart() {
            const chartDom = document.getElementById('knowledgeChart');
            const myChart = echarts.init(chartDom);
            
            const option = {
                radar: {
                    indicator: [
                        { name: 'æ•°å­¦', max: 100 },
                        { name: 'è¯­æ–‡', max: 100 },
                        { name: 'è‹±è¯­', max: 100 },
                        { name: 'ç‰©ç†', max: 100 },
                        { name: 'åŒ–å­¦', max: 100 },
                        { name: 'ç”Ÿç‰©', max: 100 },
                        { name: 'å†å²', max: 100 },
                        { name: 'åœ°ç†', max: 100 }
                    ],
                    splitArea: {
                        areaStyle: {
                            color: ['rgba(255, 255, 255, 0.05)', 'rgba(255, 255, 255, 0.02)']
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: [85, 78, 92, 65, 70, 80, 75, 68],
                        name: 'çŸ¥è¯†ç‚¹æŒæ¡ç¨‹åº¦',
                        areaStyle: {
                            color: 'rgba(79, 70, 229, 0.3)'
                        },
                        lineStyle: {
                            color: 'rgba(79, 70, 229, 0.8)',
                            width: 2
                        },
                        itemStyle: {
                            color: 'rgba(79, 70, 229, 1)'
                        }
                    }]
                }]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
        
        // åˆå§‹åŒ–å­¦ä¹ è¶‹åŠ¿å›¾è¡¨
        function initLearningTrendChart() {
            const chartDom = document.getElementById('learningTrendChart');
            const myChart = echarts.init(chartDom);
            
            // è·å–æœ€è¿‘7å¤©çš„æ—¥æœŸ
            const dates = [];
            const data = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dates.push(formatDate(dateStr));
                
                // ä»æœ¬åœ°å­˜å‚¨è·å–æ•°æ®
                const savedData = localStorage.getItem('studyData');
                if (savedData) {
                    try {
                        const studyData = JSON.parse(savedData);
                        const seconds = studyData[dateStr] || 0;
                        // è½¬æ¢ä¸ºå°æ—¶
                        data.push(parseFloat((seconds / 3600).toFixed(1)));
                    } catch (error) {
                        data.push(0);
                    }
                } else {
                    // æ¨¡æ‹Ÿæ•°æ®
                    data.push(parseFloat((Math.random() * 3 + 1).toFixed(1)));
                }
            }
            
            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.3)'
                        }
                    },
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        rotate: 45
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'å­¦ä¹ æ—¶é•¿ï¼ˆå°æ—¶ï¼‰',
                    nameTextStyle: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.3)'
                        }
                    },
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                series: [{
                    name: 'å­¦ä¹ æ—¶é•¿',
                    type: 'line',
                    data: data,
                    smooth: true,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                            { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                        ])
                    },
                    lineStyle: {
                        color: 'rgba(16, 185, 129, 0.8)',
                        width: 2
                    },
                    itemStyle: {
                        color: 'rgba(16, 185, 129, 1)'
                    }
                }]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            }
        }
        
        // å…¨å±€è®¾ç½®ç®¡ç†
        const GlobalSettings = {
            // é»˜è®¤è®¾ç½®
            defaultSettings: {
                dataset: 'assistments2009',
                model: 'tensor_attention',
                ktModel: 'dkt',
                adaptive: false,
                studyGoal: 120,
                sidebarCollapsed: false
            },
            
            // åŠ è½½è®¾ç½®
            loadSettings() {
                try {
                    const saved = localStorage.getItem('globalSettings');
                    return saved ? JSON.parse(saved) : this.defaultSettings;
                } catch (error) {
                    console.error('Failed to load settings:', error);
                    return this.defaultSettings;
                }
            },
            
            // ä¿å­˜è®¾ç½®
            saveSettings(settings) {
                try {
                    localStorage.setItem('globalSettings', JSON.stringify(settings));
                    return true;
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    return false;
                }
            },
            
            // é‡ç½®é»˜è®¤è®¾ç½®
            resetSettings() {
                this.saveSettings(this.defaultSettings);
                this.applySettings(this.defaultSettings);
            },
            
            // åº”ç”¨è®¾ç½®åˆ°UI
            applySettings(settings) {
                document.getElementById('datasetSelect').value = settings.dataset;
                document.getElementById('modelSelect').value = settings.model;
                document.getElementById('ktModelSelect').value = settings.ktModel;
                document.getElementById('adaptiveToggle').checked = settings.adaptive;
                document.getElementById('studyGoalInput').value = settings.studyGoal;
                
                // åº”ç”¨ä¾§è¾¹æ çŠ¶æ€
                this.toggleSidebar(settings.sidebarCollapsed);
            },
            
            // è·å–å½“å‰è®¾ç½®
            getCurrentSettings() {
                return {
                    dataset: document.getElementById('datasetSelect').value,
                    model: document.getElementById('modelSelect').value,
                    ktModel: document.getElementById('ktModelSelect').value,
                    adaptive: document.getElementById('adaptiveToggle').checked,
                    studyGoal: parseInt(document.getElementById('studyGoalInput').value) || 120,
                    sidebarCollapsed: document.querySelector('.settings-sidebar').classList.contains('collapsed')
                };
            },
            
            // åˆ‡æ¢ä¾§è¾¹æ çŠ¶æ€
            toggleSidebar(collapsed) {
                const sidebar = document.querySelector('.settings-sidebar');
                const container = document.querySelector('.dashboard-container');
                const toggleBtn = document.getElementById('sidebarToggle');
                
                console.log('toggleSidebar called, collapsed:', collapsed);
                console.log('sidebar:', sidebar);
                console.log('container:', container);
                console.log('toggleBtn:', toggleBtn);
                
                if (collapsed === undefined) {
                    collapsed = !sidebar.classList.contains('collapsed');
                }
                
                console.log('final collapsed value:', collapsed);
                
                if (collapsed) {
                    sidebar.classList.add('collapsed');
                    container.classList.add('sidebar-collapsed');
                    toggleBtn.innerHTML = '<span>Â»</span>';
                    console.log('Sidebar collapsed');
                } else {
                    sidebar.classList.remove('collapsed');
                    container.classList.remove('sidebar-collapsed');
                    toggleBtn.innerHTML = '<span>Â«</span>';
                    console.log('Sidebar expanded');
                }
                
                // ä¿å­˜çŠ¶æ€
                const settings = this.getCurrentSettings();
                this.saveSettings(settings);
            }
        };
        
        // åˆå§‹åŒ–å…¨å±€è®¾ç½®
        function initGlobalSettings() {
            const settings = GlobalSettings.loadSettings();
            GlobalSettings.applySettings(settings);
            
            // ä¿å­˜è®¾ç½®æŒ‰é’®
            document.getElementById('saveSettings').addEventListener('click', function() {
                const settings = GlobalSettings.getCurrentSettings();
                if (GlobalSettings.saveSettings(settings)) {
                    showNotification('è®¾ç½®å·²ä¿å­˜', 'success');
                } else {
                    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            });
            
            // é‡ç½®è®¾ç½®æŒ‰é’®
            document.getElementById('resetSettings').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
                    GlobalSettings.resetSettings();
                    showNotification('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
                }
            });
            
            // ä¾§è¾¹æ æ”¶èµ·æŒ‰é’®
            const sidebarToggleBtn = document.getElementById('sidebarToggle');
            console.log('sidebarToggleBtn:', sidebarToggleBtn);
            if (sidebarToggleBtn) {
                sidebarToggleBtn.addEventListener('click', function() {
                    console.log('Sidebar toggle button clicked');
                    GlobalSettings.toggleSidebar();
                });
            } else {
                console.error('sidebarToggle button not found');
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // æ·»åŠ æ ·å¼
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            
            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#4caf50';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#f44336';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ff9800';
                    break;
                default:
                    notification.style.backgroundColor = '#2196f3';
            }
            
            // æ·»åŠ åŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    if (style.parentNode) {
                        style.parentNode.removeChild(style);
                    }
                }, 300);
            }, 3000);
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            loadStudyData();
            
            document.getElementById('startTimer').addEventListener('click', startTimer);
            document.getElementById('stopTimer').addEventListener('click', stopTimer);
            document.getElementById('resetTimer').addEventListener('click', resetStudyData);
            document.getElementById('viewHistory').addEventListener('click', viewHistory);
            document.getElementById('exportHistory').addEventListener('click', exportHistory);
            
            // å…³é—­å¼¹çª—äº‹ä»¶
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', closeModal);
            });
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('encouragementModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // åˆå§‹åŒ–å›¾è¡¨
            initKnowledgeChart();
            initLearningTrendChart();
            
            // åˆå§‹åŒ–å…¨å±€è®¾ç½®
            initGlobalSettings();
        });
    </script>
</body>
</html>